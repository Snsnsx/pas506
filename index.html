<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>–ü—Ä–æ–≤–µ—Ä–æ—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞ ‚Äî –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</title>
<link href="https://fonts.googleapis.com/css2?family=Russo+One&family=PT+Sans:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0d1117;
    --surface: #161b22;
    --card: #1c2128;
    --border: #30363d;
    --accent: #58a6ff;
    --accent2: #3fb950;
    --warn: #f0883e;
    --danger: #f85149;
    --text: #e6edf3;
    --muted: #8b949e;
    --radius: 12px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'PT Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
    -webkit-user-select: none;
    user-select: none;
  }
  /* ---- TOP BAR ---- */
  #topbar {
    position: fixed; top: 0; left: 0; right: 0; z-index: 100;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
    padding: 10px 16px; gap: 12px;
  }
  #student-name-display { font-family:'Russo One',sans-serif; font-size:.9rem; color:var(--accent); }
  #timer {
    font-family:'Russo One',sans-serif; font-size:1.4rem;
    background: var(--card); border:2px solid var(--border);
    padding: 4px 14px; border-radius:8px; letter-spacing:2px;
    transition: color .3s, border-color .3s;
  }
  #timer.warn { color:var(--warn); border-color:var(--warn); }
  #timer.danger { color:var(--danger); border-color:var(--danger); animation: pulse 1s infinite; }
  #warn-badge {
    font-size:.75rem; background:var(--danger);
    color:#fff; padding:3px 10px; border-radius:20px;
    display:none;
  }
  #warn-badge.visible { display:block; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.5} }

  /* ---- SCREENS ---- */
  .screen { display:none; min-height:100vh; padding: 80px 16px 40px; }
  .screen.active { display:block; }

  /* ---- LOGIN ---- */
  #screen-login {
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    padding:20px;
  }
  #screen-login.active { display:flex; }
  .login-box {
    background: var(--surface);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding: 36px 28px;
    width:100%; max-width:420px;
    text-align:center;
  }
  .login-box h1 { font-family:'Russo One',sans-serif; font-size:1.6rem; margin-bottom:6px; }
  .login-box p { color:var(--muted); font-size:.9rem; margin-bottom:28px; }
  .input-group { margin-bottom:16px; text-align:left; }
  .input-group label { display:block; font-size:.8rem; color:var(--muted); margin-bottom:6px; text-transform:uppercase; letter-spacing:.05em; }
  .input-group input {
    width:100%; padding:12px 14px;
    background:var(--card); border:1px solid var(--border);
    border-radius:8px; color:var(--text); font-size:1rem; font-family:inherit;
    outline:none; transition:border-color .2s;
  }
  .input-group input:focus { border-color:var(--accent); }
  .btn {
    display:inline-flex; align-items:center; justify-content:center;
    padding:12px 28px; border-radius:8px; border:none; cursor:pointer;
    font-family:'PT Sans',sans-serif; font-size:1rem; font-weight:700;
    transition:opacity .2s, transform .1s;
  }
  .btn:active { transform:scale(.97); }
  .btn-primary { background:var(--accent); color:#0d1117; width:100%; margin-top:8px; }
  .btn-primary:hover { opacity:.88; }
  .rules { margin-top:20px; background:var(--card); border-radius:8px; padding:14px 16px; text-align:left; font-size:.82rem; color:var(--muted); border:1px solid var(--border); }
  .rules li { margin-left:16px; margin-bottom:4px; }

  /* ---- TASKS ---- */
  h2 { font-family:'Russo One',sans-serif; font-size:1.3rem; margin-bottom:4px; }
  .task-intro { color:var(--muted); font-size:.88rem; margin-bottom:18px; }
  .card {
    background:var(--surface); border:1px solid var(--border);
    border-radius:var(--radius); padding:20px; margin-bottom:20px;
  }
  .score-tag {
    display:inline-block; font-size:.72rem; background:var(--accent);
    color:#0d1117; border-radius:20px; padding:2px 10px; margin-left:8px;
    font-weight:700; vertical-align:middle;
  }
  .score-tag.green { background:var(--accent2); }

  /* ---- CHART (task1) ---- */
  #chart1-container { position:relative; width:100%; height:220px; margin-bottom:16px; }
  canvas { border-radius:8px; }

  /* data table */
  .data-table { width:100%; border-collapse:collapse; font-size:.85rem; margin-bottom:16px; }
  .data-table th, .data-table td { border:1px solid var(--border); padding:6px 10px; text-align:center; }
  .data-table th { background:var(--card); color:var(--muted); font-weight:700; }
  .data-table td { background:var(--surface); }

  /* answer inputs */
  .answer-row { display:flex; align-items:center; gap:10px; margin-bottom:12px; flex-wrap:wrap; }
  .answer-row label { font-size:.9rem; min-width:110px; }
  .answer-row input[type=number] {
    width:110px; padding:8px 12px;
    background:var(--card); border:1px solid var(--border);
    border-radius:8px; color:var(--text); font-size:1rem; font-family:inherit;
    outline:none;
  }
  .answer-row input[type=number]:focus { border-color:var(--accent); }

  /* ---- TASK 2 sliders ---- */
  .slider-group { margin-bottom:16px; }
  .slider-label { display:flex; justify-content:space-between; font-size:.83rem; color:var(--muted); margin-bottom:4px; }
  .slider-label span { color:var(--text); font-weight:700; }
  input[type=range] {
    width:100%; -webkit-appearance:none; height:6px;
    background:var(--border); border-radius:3px; outline:none;
  }
  input[type=range]::-webkit-slider-thumb {
    -webkit-appearance:none; width:20px; height:20px;
    border-radius:50%; background:var(--accent); cursor:pointer;
    box-shadow:0 0 0 3px rgba(88,166,255,.25);
  }
  input[type=range].green::-webkit-slider-thumb { background:var(--accent2); box-shadow:0 0 0 3px rgba(63,185,80,.25); }
  #hist2-container { position:relative; width:100%; height:220px; margin:16px 0; }

  /* data list task2 */
  .data-list { display:flex; flex-wrap:wrap; gap:6px; margin-bottom:14px; }
  .data-list span {
    background:var(--card); border:1px solid var(--border);
    border-radius:6px; padding:3px 10px; font-size:.8rem; color:var(--muted);
  }

  /* ---- RESULT ---- */
  #screen-result { text-align:center; }
  #screen-result.active { display:flex; flex-direction:column; align-items:center; justify-content:center; }
  .result-box {
    background:var(--surface); border:1px solid var(--border);
    border-radius:var(--radius); padding:36px 28px; max-width:440px; width:100%;
  }
  .grade-circle {
    width:100px; height:100px; border-radius:50%;
    display:flex; align-items:center; justify-content:center;
    font-family:'Russo One',sans-serif; font-size:3rem;
    margin:0 auto 20px; border:4px solid;
  }
  .grade-5 { color:var(--accent2); border-color:var(--accent2); }
  .grade-4 { color:var(--accent); border-color:var(--accent); }
  .grade-3 { color:var(--warn); border-color:var(--warn); }
  .grade-2 { color:var(--danger); border-color:var(--danger); }
  .result-breakdown { font-size:.88rem; color:var(--muted); margin-top:16px; text-align:left; border-top:1px solid var(--border); padding-top:14px; }
  .result-breakdown div { display:flex; justify-content:space-between; margin-bottom:6px; }
  .result-breakdown .val { color:var(--text); font-weight:700; }
  .annul-box { color:var(--danger); font-size:1.1rem; margin-bottom:16px; }

  /* ---- BANNER ---- */
  #banner {
    display:none; position:fixed; inset:0; z-index:999;
    background:rgba(248,81,73,.96); color:#fff;
    flex-direction:column; align-items:center; justify-content:center;
    text-align:center; padding:30px;
  }
  #banner.show { display:flex; }
  #banner h2 { font-family:'Russo One',sans-serif; font-size:2rem; margin-bottom:10px; }
  #banner p { font-size:1rem; max-width:340px; margin-bottom:20px; }
  #banner button { background:#fff; color:var(--danger); font-weight:700; padding:12px 28px; border:none; border-radius:8px; cursor:pointer; font-size:1rem; }

  /* ---- SUBMIT ---- */
  #submit-btn { width:100%; margin-top:10px; font-size:1.1rem; padding:16px; }
  .nav-btns { display:flex; gap:10px; margin-top:16px; }
  .btn-outline { background:transparent; border:2px solid var(--accent); color:var(--accent); }
  .btn-outline:hover { background:var(--accent); color:#0d1117; }

  /* Task tabs */
  .task-tabs { display:flex; gap:8px; margin-bottom:20px; }
  .tab-btn {
    flex:1; padding:10px; border:2px solid var(--border);
    border-radius:8px; background:var(--card); color:var(--muted);
    cursor:pointer; font-family:'PT Sans',sans-serif; font-weight:700;
    transition:all .2s;
  }
  .tab-btn.active { border-color:var(--accent); color:var(--accent); background:rgba(88,166,255,.1); }
  .tab-content { display:none; }
  .tab-content.active { display:block; }

  #annul-screen {
    display:none; position:fixed; inset:0; z-index:998;
    background:var(--bg); flex-direction:column; align-items:center;
    justify-content:center; text-align:center; padding:30px;
  }
  #annul-screen.show { display:flex; }
  #annul-screen h2 { font-family:'Russo One',sans-serif; color:var(--danger); font-size:2rem; margin-bottom:12px; }

  @media(max-width:400px) {
    #timer { font-size:1.1rem; padding:3px 10px; }
    .answer-row input[type=number] { width:90px; }
  }
</style>
</head>
<body>

<!-- TOP BAR -->
<div id="topbar" style="display:none">
  <div id="student-name-display"></div>
  <div id="timer">20:00</div>
  <div id="warn-badge">‚ö† <span id="warn-count">0</span> –∑–∞–º–µ—á.</div>
</div>

<!-- BANNER: –ø–æ–∫–∏–Ω—É–ª —Å—Ç—Ä–∞–Ω–∏—Ü—É -->
<div id="banner">
  <h2>‚ö† –ó–∞–º–µ—á–∞–Ω–∏–µ!</h2>
  <p id="banner-text">–í—ã –ø–æ–∫–∏–Ω—É–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–æ–≤–µ—Ä–æ—á–Ω–æ–π —Ä–∞–±–æ—Ç—ã. –≠—Ç–æ –∑–∞–º–µ—á–∞–Ω–∏–µ –±—É–¥–µ—Ç —É—á—Ç–µ–Ω–æ.</p>
  <button onclick="dismissBanner()">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–∞–±–æ—Ç–µ</button>
</div>

<!-- –ê–ù–ù–£–õ–ò–†–û–í–ê–ù–ò–ï -->
<div id="annul-screen">
  <h2>–†–∞–±–æ—Ç–∞ –∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω–∞</h2>
  <p style="color:var(--muted);max-width:340px">–í—ã –ø–æ–ª—É—á–∏–ª–∏ 3 –∏ –±–æ–ª–µ–µ –∑–∞–º–µ—á–∞–Ω–∏–π. –†–∞–±–æ—Ç–∞ –∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω–∞ –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ —É—á–∏—Ç–µ–ª—é —Å –Ω—É–ª–µ–≤—ã–º –±–∞–ª–ª–æ–º.</p>
</div>

<!-- –≠–ö–†–ê–ù: –í–≤–æ–¥ –∏–º–µ–Ω–∏ -->
<div id="screen-login" class="screen active">
  <div class="login-box">
    <h1>üìä –ü—Ä–æ–≤–µ—Ä–æ—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞</h1>
    <p>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –¥–∏–∞–≥—Ä–∞–º–º—ã ¬∑ 20 –º–∏–Ω—É—Ç</p>
    <div class="input-group">
      <label>–§–∞–º–∏–ª–∏—è</label>
      <input type="text" id="inp-last" placeholder="–ò–≤–∞–Ω–æ–≤" autocomplete="off">
    </div>
    <div class="input-group">
      <label>–ò–º—è</label>
      <input type="text" id="inp-first" placeholder="–ò–≤–∞–Ω" autocomplete="off">
    </div>
    <button class="btn btn-primary" onclick="startTest()">–ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É ‚Üí</button>
    <div class="rules">
      <strong>–ü—Ä–∞–≤–∏–ª–∞:</strong>
      <ul>
        <li>–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è ‚Äî 20 –º–∏–Ω—É—Ç</li>
        <li>–ù–µ –ø–æ–∫–∏–¥–∞–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É (–∑–∞–º–µ—á–∞–Ω–∏–µ)</li>
        <li>2 –∑–∞–º–µ—á–∞–Ω–∏—è ‚Äî –º–∏–Ω—É—Å 1 –±–∞–ª–ª</li>
        <li>3+ –∑–∞–º–µ—á–∞–Ω–∏—è ‚Äî –∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ</li>
        <li>–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å–∫—Ä–∏–Ω—à–æ—Ç—ã –∑–∞–ø—Ä–µ—â–µ–Ω—ã</li>
      </ul>
    </div>
  </div>
</div>

<!-- –≠–ö–†–ê–ù: –ó–∞–¥–∞–Ω–∏—è -->
<div id="screen-tasks" class="screen">
  <div class="task-tabs">
    <button class="tab-btn active" onclick="showTab(1)">–ó–∞–¥–∞–Ω–∏–µ 1</button>
    <button class="tab-btn" onclick="showTab(2)">–ó–∞–¥–∞–Ω–∏–µ 2</button>
  </div>

  <!-- –ó–ê–î–ê–ù–ò–ï 1 -->
  <div id="tab1" class="tab-content active">
    <h2>–ó–∞–¥–∞–Ω–∏–µ 1 <span class="score-tag">–¥–æ 3 –±–∞–ª–ª–æ–≤</span></h2>
    <p class="task-intro">–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Å—Ç–æ–ª–±—á–∞—Ç—É—é –¥–∏–∞–≥—Ä–∞–º–º—É –∏ –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã.</p>

    <div class="card">
      <p style="font-size:.85rem;color:var(--muted);margin-bottom:10px;">–î–∞–Ω–Ω—ã–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π:</p>
      <table class="data-table" id="table1"></table>
      <div id="chart1-container">
        <canvas id="chart1"></canvas>
      </div>
    </div>

    <div class="card">
      <p style="font-size:.88rem;font-weight:700;margin-bottom:14px;">–í–∞—à–∏ –æ—Ç–≤–µ—Ç—ã:</p>
      <div class="answer-row">
        <label>–°—Ä–µ–¥–Ω–µ–µ:</label>
        <input type="number" id="ans1-mean" step="0.01" placeholder="0.00">
      </div>
      <div class="answer-row">
        <label>–ú–µ–¥–∏–∞–Ω–∞:</label>
        <input type="number" id="ans1-median" step="0.01" placeholder="0.00">
      </div>
    </div>

    <div class="nav-btns">
      <button class="btn btn-outline" style="flex:1" onclick="showTab(2)">–ó–∞–¥–∞–Ω–∏–µ 2 ‚Üí</button>
    </div>
  </div>

  <!-- –ó–ê–î–ê–ù–ò–ï 2 -->
  <div id="tab2" class="tab-content">
    <h2>–ó–∞–¥–∞–Ω–∏–µ 2 <span class="score-tag green">–¥–æ 3 –±–∞–ª–ª–æ–≤</span></h2>
    <p class="task-intro">–ò—Å–ø–æ–ª—å–∑—É—è –ø–æ–ª–∑—É–Ω–∫–∏, –ø–æ—Å—Ç—Ä–æ–π—Ç–µ –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—É —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö (6 —Å—Ç–æ–ª–±–∏–∫–æ–≤) –∏ —É–∫–∞–∂–∏—Ç–µ —Å—Ä–µ–¥–Ω–µ–µ –∏ –º–µ–¥–∏–∞–Ω—É.</p>

    <div class="card">
      <p style="font-size:.85rem;color:var(--muted);margin-bottom:8px;">–ù–∞–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö (30 –∑–Ω–∞—á–µ–Ω–∏–π):</p>
      <div class="data-list" id="data2-list"></div>
    </div>

    <div class="card">
      <p style="font-size:.85rem;color:var(--muted);margin-bottom:12px;">–í—ã—Å–æ—Ç–∞ –∫–∞–∂–¥–æ–≥–æ —Å—Ç–æ–ª–±–∏–∫–∞ (—á–∞—Å—Ç–æ—Ç–∞):</p>
      <div id="sliders-hist"></div>
      <div id="hist2-container">
        <canvas id="chart2"></canvas>
      </div>
    </div>

    <div class="card">
      <p style="font-size:.88rem;font-weight:700;margin-bottom:14px;">–°—Ä–µ–¥–Ω–µ–µ –∏ –º–µ–¥–∏–∞–Ω–∞:</p>
      <div class="slider-group">
        <div class="slider-label">–°—Ä–µ–¥–Ω–µ–µ: <span id="val-mean2">0</span></div>
        <input type="range" id="sl-mean2" min="0" max="100" value="0" oninput="document.getElementById('val-mean2').textContent=parseFloat(this.value).toFixed(1)">
      </div>
      <div class="slider-group">
        <div class="slider-label">–ú–µ–¥–∏–∞–Ω–∞: <span id="val-median2">0</span></div>
        <input type="range" class="green" id="sl-median2" min="0" max="100" value="0" oninput="document.getElementById('val-median2').textContent=parseFloat(this.value).toFixed(1)">
      </div>
    </div>

    <button id="submit-btn" class="btn btn-primary" onclick="submitWork()">‚úî –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∞–±–æ—Ç—É</button>
  </div>
</div>

<!-- –≠–ö–†–ê–ù: –†–µ–∑—É–ª—å—Ç–∞—Ç -->
<div id="screen-result" class="screen">
  <div class="result-box">
    <div id="annul-result" class="annul-box" style="display:none">–†–∞–±–æ—Ç–∞ –∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω–∞</div>
    <div id="grade-circle" class="grade-circle grade-5">5</div>
    <h2 id="result-label" style="font-size:1.4rem;margin-bottom:6px;"></h2>
    <p id="result-name" style="color:var(--muted);font-size:.9rem;"></p>
    <div class="result-breakdown" id="result-breakdown"></div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script>
// ===== STATE =====
let studentName = '';
let warnings = 0;
let annulled = false;
let timerInterval = null;
let timeLeft = 20 * 60;
let testStarted = false;
let chart1Inst = null, chart2Inst = null;

// task1 data
let t1x = [], t1y = [], t1mean = 0, t1median = 0;
// task2 data
let t2data = [], t2bins = [], t2mean = 0, t2median = 0;
const BIN_COUNT = 6;

// ===== SCREENSHOT / COPY PREVENTION =====
document.addEventListener('copy', e => e.preventDefault());
document.addEventListener('cut', e => e.preventDefault());
document.addEventListener('contextmenu', e => { if(testStarted) e.preventDefault(); });
document.addEventListener('keydown', e => {
  if(!testStarted) return;
  // PrintScreen
  if(e.key === 'PrintScreen') {
    e.preventDefault();
    document.body.style.filter = 'blur(12px)';
    setTimeout(() => document.body.style.filter = '', 1500);
    triggerWarning('–ü–æ–ø—ã—Ç–∫–∞ —Å–¥–µ–ª–∞—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞.');
  }
  // Ctrl+P, Ctrl+S, F12
  if((e.ctrlKey && ['p','s','u'].includes(e.key.toLowerCase())) || e.key==='F12') {
    e.preventDefault();
  }
});

// ===== VISIBILITY =====
document.addEventListener('visibilitychange', () => {
  if(!testStarted || annulled) return;
  if(document.hidden) triggerWarning('–í—ã –ø–æ–∫–∏–Ω—É–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–æ–≤–µ—Ä–æ—á–Ω–æ–π —Ä–∞–±–æ—Ç—ã.');
});
window.addEventListener('blur', () => {
  if(!testStarted || annulled) return;
  triggerWarning('–í—ã –ø–µ—Ä–µ–∫–ª—é—á–∏–ª–∏—Å—å –Ω–∞ –¥—Ä—É–≥–æ–µ –æ–∫–Ω–æ.');
});

function triggerWarning(msg) {
  if(annulled) return;
  warnings++;
  document.getElementById('warn-count').textContent = warnings;
  document.getElementById('warn-badge').classList.add('visible');

  if(warnings >= 3) {
    annulled = true;
    document.getElementById('banner').classList.remove('show');
    document.getElementById('annul-screen').classList.add('show');
    clearInterval(timerInterval);
    sendResults(true);
    return;
  }
  let bannerText = msg;
  if(warnings === 2) bannerText += ' –≠—Ç–æ –≤–∞—à–µ 2-–µ –∑–∞–º–µ—á–∞–Ω–∏–µ ‚Äî —Å –≤–∞—Å –≤—ã—á—Ç–µ–Ω 1 –±–∞–ª–ª!';
  document.getElementById('banner-text').textContent = bannerText + ` (–∑–∞–º–µ—á–∞–Ω–∏–µ ${warnings} –∏–∑ 3)`;
  document.getElementById('banner').classList.add('show');
}

function dismissBanner() {
  document.getElementById('banner').classList.remove('show');
}

// ===== TIMER =====
function startTimer() {
  timerInterval = setInterval(() => {
    timeLeft--;
    const m = Math.floor(timeLeft/60).toString().padStart(2,'0');
    const s = (timeLeft%60).toString().padStart(2,'0');
    const el = document.getElementById('timer');
    el.textContent = `${m}:${s}`;
    if(timeLeft <= 120) el.classList.add('warn');
    if(timeLeft <= 30) { el.classList.remove('warn'); el.classList.add('danger'); }
    if(timeLeft <= 0) {
      clearInterval(timerInterval);
      submitWork();
    }
  }, 1000);
}

// ===== DATA GENERATION =====
function randInt(min, max) { return Math.floor(Math.random()*(max-min+1))+min; }

function generateTask1() {
  t1x = [];
  t1y = [];
  const base = randInt(10,40);
  for(let i=0;i<6;i++) { t1x.push(base + i*randInt(3,8)); t1y.push(randInt(2,12)); }
  // mean weighted
  let sumxy=0, sumy=0;
  for(let i=0;i<6;i++){sumxy+=t1x[i]*t1y[i]; sumy+=t1y[i];}
  t1mean = Math.round((sumxy/sumy)*100)/100;
  // median: expand
  let expanded = [];
  for(let i=0;i<6;i++) for(let j=0;j<t1y[i];j++) expanded.push(t1x[i]);
  expanded.sort((a,b)=>a-b);
  const mid = Math.floor(expanded.length/2);
  t1median = expanded.length%2===0 ? Math.round((expanded[mid-1]+expanded[mid])/2*100)/100 : expanded[mid];
}

function generateTask2() {
  t2data = [];
  const center = randInt(30,60), spread = randInt(8,15);
  for(let i=0;i<30;i++) {
    let v = Math.round(center + (Math.random()-0.5)*2*spread);
    v = Math.max(1,Math.min(100,v));
    t2data.push(v);
  }
  t2data.sort((a,b)=>a-b);
  const mn = Math.min(...t2data), mx = Math.max(...t2data);
  const range = mx-mn || 1;
  const step = range/BIN_COUNT;
  t2bins = [];
  for(let i=0;i<BIN_COUNT;i++) {
    const lo = mn+i*step, hi = mn+(i+1)*step;
    const cnt = t2data.filter(v => i===BIN_COUNT-1 ? v>=lo&&v<=hi : v>=lo&&v<hi).length;
    t2bins.push({lo:Math.round(lo), hi:Math.round(hi), cnt});
  }
  t2mean = Math.round(t2data.reduce((a,b)=>a+b,0)/t2data.length*10)/10;
  const mid2 = Math.floor(t2data.length/2);
  t2median = t2data.length%2===0?(t2data[mid2-1]+t2data[mid2])/2:t2data[mid2];

  // update sliders range
  const maxCnt = Math.max(...t2bins.map(b=>b.cnt))+3;
  document.querySelectorAll('.hist-slider').forEach(sl=>{ sl.max=maxCnt; });
  const dataRange = mx-mn;
  const meanSl = document.getElementById('sl-mean2');
  const medSl  = document.getElementById('sl-median2');
  meanSl.min = mn; meanSl.max = mx; meanSl.value = Math.round((mn+mx)/2); meanSl.step=0.1;
  medSl.min  = mn; medSl.max  = mx; medSl.value = Math.round((mn+mx)/2); medSl.step=0.1;
  document.getElementById('val-mean2').textContent   = meanSl.value;
  document.getElementById('val-median2').textContent = medSl.value;
}

// ===== RENDER =====
function buildTable1() {
  const t = document.getElementById('table1');
  t.innerHTML = `<tr><th>x</th>${t1x.map(v=>`<td>${v}</td>`).join('')}</tr>
    <tr><th>–ß–∞—Å—Ç–æ—Ç–∞</th>${t1y.map(v=>`<td>${v}</td>`).join('')}</tr>`;
}

function buildChart1() {
  const ctx = document.getElementById('chart1').getContext('2d');
  if(chart1Inst) chart1Inst.destroy();
  chart1Inst = new Chart(ctx, {
    type:'bar',
    data:{ labels:t1x, datasets:[{ label:'–ß–∞—Å—Ç–æ—Ç–∞', data:t1y,
      backgroundColor:'rgba(88,166,255,.7)', borderColor:'rgba(88,166,255,1)', borderWidth:1,
      borderRadius:4 }]},
    options:{ responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{display:false} },
      scales:{ x:{ticks:{color:'#8b949e'}, grid:{color:'#30363d'}},
               y:{ticks:{color:'#8b949e'}, grid:{color:'#30363d'}, beginAtZero:true} } }
  });
}

function buildDataList2() {
  const c = document.getElementById('data2-list');
  c.innerHTML = t2data.map(v=>`<span>${v}</span>`).join('');
}

function buildSlidersHist() {
  const c = document.getElementById('sliders-hist');
  c.innerHTML = '';
  t2bins.forEach((b,i) => {
    const maxC = Math.max(...t2bins.map(x=>x.cnt))+5;
    c.innerHTML += `<div class="slider-group">
      <div class="slider-label">[${b.lo}‚Äì${b.hi}]: <span id="sv${i}">0</span></div>
      <input type="range" class="hist-slider" id="hs${i}" min="0" max="${maxC}" value="0"
        oninput="document.getElementById('sv${i}').textContent=this.value; updateChart2()">
    </div>`;
  });
}

function buildChart2() {
  const ctx = document.getElementById('chart2').getContext('2d');
  if(chart2Inst) chart2Inst.destroy();
  const labels = t2bins.map(b=>`${b.lo}‚Äì${b.hi}`);
  chart2Inst = new Chart(ctx, {
    type:'bar',
    data:{ labels, datasets:[{ label:'–ß–∞—Å—Ç–æ—Ç–∞', data:Array(BIN_COUNT).fill(0),
      backgroundColor:'rgba(63,185,80,.7)', borderColor:'rgba(63,185,80,1)', borderWidth:1,
      borderRadius:4 }]},
    options:{ responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{display:false} },
      scales:{ x:{ticks:{color:'#8b949e'}, grid:{color:'#30363d'}},
               y:{ticks:{color:'#8b949e'}, grid:{color:'#30363d'}, beginAtZero:true} } }
  });
}

function updateChart2() {
  const vals = t2bins.map((_,i) => parseInt(document.getElementById('hs'+i).value)||0);
  chart2Inst.data.datasets[0].data = vals;
  chart2Inst.update('none');
}

// ===== TABS =====
function showTab(n) {
  [1,2].forEach(i => {
    document.getElementById('tab'+i).classList.toggle('active', i===n);
    document.querySelectorAll('.tab-btn')[i-1].classList.toggle('active', i===n);
  });
}

// ===== START =====
function startTest() {
  const last = document.getElementById('inp-last').value.trim();
  const first = document.getElementById('inp-first').value.trim();
  if(!last || !first) { alert('–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é –∏ –∏–º—è'); return; }
  studentName = last + ' ' + first;

  generateTask1();
  generateTask2();
  buildTable1();
  buildSlidersHist();

  showScreen('screen-tasks');
  document.getElementById('topbar').style.display = 'flex';
  document.getElementById('student-name-display').textContent = studentName;

  // wait one tick for canvas to be visible
  setTimeout(() => { buildChart1(); buildChart2(); }, 50);

  testStarted = true;
  startTimer();
}

// ===== SCORING =====
function calcScore() {
  let score = 0;
  const tol = v => Math.abs(v) * 0.05 + 0.5; // 5% tolerance

  // Task 1: chart always shown = 1 point
  score += 1;

  // mean
  const ansMean1 = parseFloat(document.getElementById('ans1-mean').value);
  if(!isNaN(ansMean1) && Math.abs(ansMean1 - t1mean) <= tol(t1mean)) score += 1;

  // median
  const ansMedian1 = parseFloat(document.getElementById('ans1-median').value);
  if(!isNaN(ansMedian1) && Math.abs(ansMedian1 - t1median) <= tol(t1median)) score += 1;

  // Task 2: histogram
  const userBins = t2bins.map((_,i) => parseInt(document.getElementById('hs'+i).value)||0);
  let histCorrect = true;
  for(let i=0;i<BIN_COUNT;i++) {
    if(Math.abs(userBins[i]-t2bins[i].cnt) > 1) { histCorrect=false; break; }
  }
  if(histCorrect) score += 1;

  const ansMean2 = parseFloat(document.getElementById('sl-mean2').value);
  if(!isNaN(ansMean2) && Math.abs(ansMean2 - t2mean) <= tol(t2mean)) score += 1;

  const ansMedian2 = parseFloat(document.getElementById('sl-median2').value);
  if(!isNaN(ansMedian2) && Math.abs(ansMedian2 - t2median) <= tol(t2median)) score += 1;

  // penalty for 2+ warnings
  if(warnings >= 2) score = Math.max(0, score - 1);

  return score;
}

function getGrade(score) {
  if(score >= 6) return 5;
  if(score === 5) return 4;
  if(score >= 3) return 3;
  return 2;
}

// ===== SUBMIT =====
function submitWork() {
  clearInterval(timerInterval);
  testStarted = false;
  if(annulled) return;

  const score = calcScore();
  const grade = getGrade(score);

  const gc = document.getElementById('grade-circle');
  gc.textContent = grade;
  gc.className = 'grade-circle grade-'+grade;
  document.getElementById('result-label').textContent = grade===5?'–û—Ç–ª–∏—á–Ω–æ!':grade===4?'–•–æ—Ä–æ—à–æ!':grade===3?'–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ':'–ù–µ—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ';
  document.getElementById('result-name').textContent = studentName;

  const t1mean_ans = parseFloat(document.getElementById('ans1-mean').value)||0;
  const t1med_ans  = parseFloat(document.getElementById('ans1-median').value)||0;
  const sl_mean2   = parseFloat(document.getElementById('sl-mean2').value)||0;
  const sl_med2    = parseFloat(document.getElementById('sl-median2').value)||0;

  document.getElementById('result-breakdown').innerHTML = `
    <div><span>–ë–∞–ª–ª–æ–≤ –Ω–∞–±—Ä–∞–Ω–æ:</span><span class="val">${score} / 6</span></div>
    <div><span>–ó–∞–º–µ—á–∞–Ω–∏–π:</span><span class="val">${warnings}</span></div>
    <div><span>–ó–∞–¥–∞–Ω–∏–µ 1 ‚Äî —Å—Ä–µ–¥–Ω–µ–µ (${t1mean}):</span><span class="val">${t1mean_ans}</span></div>
    <div><span>–ó–∞–¥–∞–Ω–∏–µ 1 ‚Äî –º–µ–¥–∏–∞–Ω–∞ (${t1median}):</span><span class="val">${t1med_ans}</span></div>
    <div><span>–ó–∞–¥–∞–Ω–∏–µ 2 ‚Äî —Å—Ä–µ–¥–Ω–µ–µ (${t2mean}):</span><span class="val">${sl_mean2}</span></div>
    <div><span>–ó–∞–¥–∞–Ω–∏–µ 2 ‚Äî –º–µ–¥–∏–∞–Ω–∞ (${t2median}):</span><span class="val">${sl_med2}</span></div>
  `;

  showScreen('screen-result');
  document.getElementById('topbar').style.display = 'none';
  sendResults(false, score, grade);
}

// ===== SEND TO GOOGLE SHEETS =====
// TODO: Replace with your Apps Script Web App URL
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwJEzcdUez6dvph52SqmrMiqH-c2Oe-R8iGRNpk3XtYPSplJ62dxFcnyt9bx-LTTR4DXQ/exec';

function sendResults(isAnnulled, score=0, grade=0) {
  const userBins = t2bins.map((_,i) => parseInt(document.getElementById('hs'+i)?.value||0));
  const payload = {
    timestamp: new Date().toISOString(),
    name: studentName,
    warnings,
    annulled: isAnnulled,
    score: isAnnulled ? 0 : score,
    grade: isAnnulled ? 0 : grade,
    t1_mean_correct: t1mean,
    t1_median_correct: t1median,
    t1_mean_student: parseFloat(document.getElementById('ans1-mean')?.value)||0,
    t1_median_student: parseFloat(document.getElementById('ans1-median')?.value)||0,
    t2_mean_correct: t2mean,
    t2_median_correct: t2median,
    t2_mean_student: parseFloat(document.getElementById('sl-mean2')?.value)||0,
    t2_median_student: parseFloat(document.getElementById('sl-median2')?.value)||0,
    t2_hist_correct: t2bins.map(b=>b.cnt).join(','),
    t2_hist_student: userBins.join(','),
  };
  fetch(APPS_SCRIPT_URL, {
    method:'POST',
    mode:'no-cors',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  }).catch(()=>{}); // silent fail if URL not configured
}

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}
</script>

<!-- ============================================================
     GOOGLE APPS SCRIPT ‚Äî –≤—Å—Ç–∞–≤—å—Ç–µ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä —Å–∫—Ä–∏–ø—Ç–∞ Google Sheets
================================================================

function doPost(e) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('–†–µ–∑—É–ª—å—Ç–∞—Ç—ã') 
    || SpreadsheetApp.getActiveSpreadsheet().insertSheet('–†–µ–∑—É–ª—å—Ç–∞—Ç—ã');
  
  const data = JSON.parse(e.postData.contents);
  
  if(sheet.getLastRow() === 0) {
    sheet.appendRow([
      '–í—Ä–µ–º—è','–£—á–µ–Ω–∏–∫','–ó–∞–º–µ—á–∞–Ω–∏—è','–ê–Ω–Ω—É–ª.','–ë–∞–ª–ª','–û—Ü–µ–Ω–∫–∞',
      '–°—Ä1 (–≤–µ—Ä–Ω)','–°—Ä1 (—É—á–µ–Ω)','–ú–µ–¥1 (–≤–µ—Ä–Ω)','–ú–µ–¥1 (—É—á–µ–Ω)',
      '–°—Ä2 (–≤–µ—Ä–Ω)','–°—Ä2 (—É—á–µ–Ω)','–ú–µ–¥2 (–≤–µ—Ä–Ω)','–ú–µ–¥2 (—É—á–µ–Ω)',
      '–ì–∏—Å—Ç2 –≤–µ—Ä–Ω','–ì–∏—Å—Ç2 —É—á–µ–Ω'
    ]);
  }
  
  sheet.appendRow([
    data.timestamp, data.name, data.warnings, data.annulled,
    data.score, data.grade,
    data.t1_mean_correct, data.t1_mean_student,
    data.t1_median_correct, data.t1_median_student,
    data.t2_mean_correct, data.t2_mean_student,
    data.t2_median_correct, data.t2_median_student,
    data.t2_hist_correct, data.t2_hist_student
  ]);
  
  return ContentService.createTextOutput('OK');
}

============================================================ -->

</body>
</html>
